---
import { Image } from "astro:assets";
import { listaSVG } from "../../helpers/SVGs";
import { imagenes } from "../../helpers/Multimedia.astro";
import {
  DiccionarioModalRastreoAsignado,
  DiccionarioRastrearPaquete,
} from "../../translations/DiccionarioRastrearPaquete";

const { Idioma } = Astro.props;

// IMPORTAMOS LOS ESTILOS
import "../../styles/RastrearPaquete/FormularioDeRastreo.css";
---

<div class="ModalRastreoAsignado" id="ModalRastreoAsignado">
  <div class="ModalRastreoAsignado__Contenedor" id="ContenedorModal">
    <button
      class="ModalRastreoAsignado__Contenedor--Cerrar"
      id="BotonCerrarModal"
      set:html={listaSVG({ SVG: "CERRAR", Tamaño: "16", Box: "0 0 16 16" })}
    />
    <Image
      src={imagenes.BuenasNoticias.Imagen}
      alt={DiccionarioModalRastreoAsignado.AltImgEnPaqueteria[Idioma]}
      class="ModalRastreoAsignado__Contenedor--Imagen"
      loading="eager"
    />
    <p class="ModalRastreoAsignado__Contenedor--Titulo">
      {DiccionarioModalRastreoAsignado.Titulo[Idioma]}
    </p>
    <p class="ModalRastreoAsignado__Contenedor--Parrafo">
      {DiccionarioModalRastreoAsignado.ParrafoUno[Idioma]}
    </p>
    <p class="ModalRastreoAsignado__Contenedor--Parrafo">
      {DiccionarioModalRastreoAsignado.ParrafoDos[Idioma]}
      <b id="PaqueteriaParrafo">Paquetería.</b>
      {DiccionarioModalRastreoAsignado.ParrafoTres[Idioma]}
    </p>
    <p class="ModalRastreoAsignado__Contenedor--Parrafo">
      {DiccionarioModalRastreoAsignado.NumeroRastreo[Idioma]}
      <b id="NumeroDeRastreo">000000</b>
    </p>
    <section class="ModalRastreoAsignado__Contenedor--Botones">
      <a href="#" target="_blank" id="BotonSeguimiento">
        {DiccionarioModalRastreoAsignado.BotonSeguimiento[Idioma]}
        <span id="PaqueteriaBoton">Paquetería</span>
      </a>
    </section>
  </div>
</div>
<section
  class="FormularioDeRastreo"
  aria-label={DiccionarioRastrearPaquete.FormularioAriaLabel[Idioma]}
>
  <h2 class="USMX__Subtitulos">
    {DiccionarioRastrearPaquete.Titulo[Idioma]}
  </h2>
  <div class="FormularioDeRastreo__Input">
    <input
      type="text"
      class="FormularioDeRastreo__Input--Input"
      placeholder={DiccionarioRastrearPaquete.InputPlaceholder[Idioma]}
      aria-label={DiccionarioRastrearPaquete.InputAriaLabel[Idioma]}
      name="numero_de_guia"
      id="numero_de_guia"
    />
    <button
      set:html={listaSVG({
        SVG: "PAQUETE",
        Color: "Blanco",
      })}
      class="FormularioDeRastreo__Input--SVG"
      onclick="BuscarInformacionDeUnPaquete()"
      title={DiccionarioRastrearPaquete.TituloBoton[Idioma]}
    />
  </div>
  <article class="FormularioDeRastreo__Informacion">
    <h2 class="USMX__Parrafos">
      {DiccionarioRastrearPaquete.TextoDefectoFormulario[Idioma]}
    </h2>
    <Image
      src={imagenes.InformacionDeRastreo.Imagen}
      alt={DiccionarioRastrearPaquete.AltImgDefectoFormulario[Idioma]}
      class="FormularioDeRastreo__Informacion--Imagen"
      loading="eager"
    />
  </article>
</section>

<script client:load>
  const SERVIDOR_PETICIONES = "https://www.usmxxpress.online/api/web";
  // const SERVIDOR_PETICIONES = "http://localhost:4000/api/web";
  // OBTENEMOS EL CONTENEDOR DE LA INFORMACIÓN DE UN PAQUETE
  const ContenedorDeInformacion = document.querySelector(
    ".FormularioDeRastreo__Informacion"
  );
  /** Obtenemos el idioma del navegador **/
  const IdiomaActual = document.documentElement.lang || "es";
  /** Obtenemos el input de busqueda **/
  const InputDeBusqueda = document.getElementById("numero_de_guia");
  /** Creamos un diccionario de textos **/
  const DiccionarioDeTextos = {
    BuscandoInformacion: {
      es: "Buscando información de tu paquete...",
      en: "Looking for package information...",
    },
    InformacionGeneral: {
      es: "Información general",
      en: "General information",
    },
    AltLogo: {
      es: "Logo de USMX en el formulario de rastreo",
      en: "USMX logo in the package tracking form",
    },
    Orden: {
      es: "Orden",
      en: "Order",
    },
    Destinatario: {
      es: "Destinatario: ",
      en: "Recipient: ",
    },
    Progreso: {
      es: "Progreso del envío",
      en: "Shipping progress",
    },
    AltImgBusqueda: {
      es: "Ilustración de busqueda de paquetes",
      en: "Package search illustration",
    },
    PaqueteNoEncontrado: {
      es: "No encontramos tu paquete. Por favor, verifica el número de guía e ingresa uno válido.",
      en: "We could not find your package. Please check the tracking number and enter a valid one.",
    },
    AltImgNoEncontrado: {
      es: "Ilustración de paquetes no encontrados",
      en: "Package not found illustration",
    },
    PaqueteError: {
      es: "Ocurrió un error al buscar la información del paquete.",
      en: "An error occurred while searching for package information.",
    },
    AltImgError: {
      es: "Ilustración de error de busqueda de paquetes",
      en: "Package search error illustration",
    },
  };
  /** Agregamos el evento de teclado al presionar la tecla enter **/
  InputDeBusqueda.addEventListener("keydown", (event) => {
    if (event.key === "Enter" && InputDeBusqueda.value) {
      BuscarInformacionDeUnPaquete();
    }
  });
  /** Obtenemos el modal de rastreo asignado **/
  const ModalRastreoAsignado = document.getElementById("ModalRastreoAsignado");
  ModalRastreoAsignado.addEventListener("click", () => {
    CerrarModalRastreoAsignado();
  });
  const ContenedorModal = document.getElementById("ContenedorModal");
  ContenedorModal.addEventListener("click", (e) => {
    e.stopPropagation();
  });
  /** Obtenemos el botón que cerrará el modal de rastreo asignado **/
  const BtnCerrarModal = document.getElementById("BotonCerrarModal");
  BtnCerrarModal.addEventListener("click", () => {
    CerrarModalRastreoAsignado();
  });

  const BuscarInformacionDeUnPaquete = () => {
    if (!InputDeBusqueda.value) return;
    MostrarMensajeDeCarga();
    BuscarPedidosPorNumeroDeGuia(InputDeBusqueda.value);
  };
  const BuscarPedidosPorNumeroDeGuia = async (Guia = "") => {
    try {
      // Realizar la solicitud fetch
      const res = await fetch(
        `${SERVIDOR_PETICIONES}/pedidos/BuscarPedidoPorNumeroDeGuia/${Guia}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );
      const data = await res.json();
      if (data.InformacionGeneral) {
        MostrarInformacionDeUnPaquete(data);
        /** Si ya hay un número de rastreo, mostramos un modal **/
        const { RastreoPedido } = data.InformacionGeneral;
        if (RastreoPedido) {
          const { NombrePaqueteria, RastreoPedido } = data.InformacionGeneral;
          MostrarModalDeRastreo({
            Paqueteria: NombrePaqueteria,
            Rastreo: RastreoPedido,
          });
        }
      } else {
        MostrarInformacionNoEncontrada();
      }
    } catch (error) {
      MostrarMensajeDeError();
    }
  };
  const MostrarModalDeRastreo = ({ Paqueteria, Rastreo }) => {
    /** Obtenemos el url de la paqueteria **/
    const URLPaqueteria = ObtenerUrlPaqueteria({ Paqueteria, Rastreo });
    /** Primero cambiamos los textos **/
    const PaqueteriaParrafo = document.getElementById("PaqueteriaParrafo");
    const NumeroDeRastreo = document.getElementById("NumeroDeRastreo");
    const PaqueteriaBoton = document.getElementById("PaqueteriaBoton");
    const BotonSeguimiento = document.getElementById("BotonSeguimiento");
    PaqueteriaParrafo.textContent = `${Paqueteria}.`;
    NumeroDeRastreo.textContent = `#${Rastreo}`;
    PaqueteriaBoton.textContent = Paqueteria;
    BotonSeguimiento.href = URLPaqueteria || "#";
    /** Una vez que cambiamos los textos, mostramos el modal **/
    ModalRastreoAsignado.classList.add("Activo");
  };
  const ObtenerUrlPaqueteria = ({ Paqueteria, Rastreo }) => {
    /** Creamos una lista de URLS para cada paqueteria **/
    const UrlsPaqueterias = {
      FedEx: `https://www.fedex.com/fedextrack/?trknbr=${Rastreo}`,
      Estafeta: `https://www.estafeta.com/en/rastrear-envio?rastreo=true`,
      Paquetexpress: `https://www.paquetexpress.com.mx/rastreo/${Rastreo}`,
    };
    return UrlsPaqueterias[Paqueteria];
  };
  const CerrarModalRastreoAsignado = () => {
    ModalRastreoAsignado.classList.remove("Activo");
  };
  const MostrarMensajeDeCarga = () => {
    ContenedorDeInformacion.innerHTML = `
    <p class="USMX__Parrafos">${DiccionarioDeTextos.BuscandoInformacion[IdiomaActual]}</p>
    <Image
      src="/BuscandoPaquete.png"
      alt=${DiccionarioDeTextos.AltImgBusqueda[IdiomaActual]}
      class="FormularioDeRastreo__Informacion--Imagen"
      loading="eager"
    />
  `;
  };
  const MostrarInformacionDeUnPaquete = (InfPaquete) => {
    const { InformacionGeneral, MovimientosDelPedido } = InfPaquete;
    ContenedorDeInformacion.innerHTML = "";
    ContenedorDeInformacion.innerHTML = `
    <hr class="Divisor" />
      <h3 class="USMX__SemiSubtitulos">${DiccionarioDeTextos.InformacionGeneral[IdiomaActual]}</h3>
    <div class="FormularioDeRastreo__Informacion--Encabezado">
      <Image
        src="/Icono-USMX.ico"
        alt=${DiccionarioDeTextos.AltLogo[IdiomaActual]}
        class="FormularioDeRastreo__Informacion--Encabezado--Imagen"
        loading="eager"
      />
      <span class="FormularioDeRastreo__Informacion--Encabezado--Titulo">
        <p class="USMX__Parrafos Izquierda Bold">USMX XPRESS</p>
        <small class="USMX__Small Azul Bold">${InformacionGeneral.GuiaPedido}</small>
      </span>
      <p class="USMX__Parrafos Derecha Bold DerechaOrden">
        ${DiccionarioDeTextos.Orden[IdiomaActual]} <b class="Azul">#${InformacionGeneral.idPedido}</b>
      </p>
    </div>
    <div class="FormularioDeRastreo__Informacion--Estados">
      <h3 class="USMX__SemiSubtitulos Izquierda">${InformacionGeneral.ProductoPedido}</h3>
      <p class="USMX__Parrafos Izquierda FechaEntrega Gris">
       ${DiccionarioDeTextos.Destinatario[IdiomaActual]} <b>${InformacionGeneral.NombreDestinatario} ${InformacionGeneral.PrimerApellidoDestinatario} ${InformacionGeneral.SegundoApellidoDestinatario}</b>
      </p>
    </div>
    <hr class="Divisor" />
    <div class="FomrularioDeRastreo__Informacion--Progreso">
      <h3 class="USMX__SemiSubtitulos">${DiccionarioDeTextos.Progreso[IdiomaActual]}</h3>
    </div>
    <ul class="FormularioDeRastreo__Informacion--Movimientos">
  ${MovimientosDelPedido.map(
    ({ FechaCreacionUnion, HoraCreacionUnion, DetallesMovimiento }, index) => `
    <li class="FormularioDeRastreo__Informacion--Movimientos--Movimiento">
      <p class="USMX__Parrafos Bold IzquierdaMovimiento">
        ${FormatearFecha(FechaCreacionUnion.slice(0, 10), HoraCreacionUnion)}
        ${index === 0 ? `<small class="USMX__Small Actual">Actual</small>` : ""}
      </p>
      <p class="USMX__Parrafos Gris IzquierdaMovimiento">
        ${DetallesMovimiento}
      </p>
    </li>`
  ).join("")}
</ul>
    `;
  };
  const MostrarInformacionNoEncontrada = () => {
    ContenedorDeInformacion.innerHTML = `
        <p class="USMX__Parrafos Rojo">
        ${DiccionarioDeTextos.PaqueteNoEncontrado[IdiomaActual]}
      </p>
      <Image
        src="/PaqueteNoEncontrado.png"
        alt=${DiccionarioDeTextos.AltImgNoEncontrado[IdiomaActual]}
        class="FormularioDeRastreo__Informacion--Imagen"
        loading="eager"
      />`;
  };
  const MostrarMensajeDeError = () => {
    ContenedorDeInformacion.innerHTML = `
      <p class="USMX__Parrafos Rojo">${DiccionarioDeTextos.PaqueteError[IdiomaActual]}</p>
      <Image
        src="/PaqueteError.png"
        alt=${DiccionarioDeTextos.AltImgError[IdiomaActual]}
        class="FormularioDeRastreo__Informacion--Imagen"
        loading="eager"
      />
      `;
  };
  const FormatearFecha = (Fecha, Hora) => {
    const FechaJuntada = `${Fecha}T${Hora}`;

    // Crear un objeto Date
    const NuevaFecha = new Date(FechaJuntada);

    // Opciones de formato
    const Opciones = {
      month: "long", // Nombre completo del mes
      day: "2-digit", // Día con dos dígitos
      year: "numeric", // Año con cuatro dígitos
      hour: "2-digit", // Hora con dos dígitos
      minute: "2-digit", // Minutos con dos dígitos
      hour12: true, // Usar formato de 12 horas (AM/PM)
    };

    // Crear el formateador
    const Formateador = new Intl.DateTimeFormat("es-ES", Opciones);

    // Formatear la fecha
    return Formateador.format(NuevaFecha);
  };
  /** Obtenemos los parámetros de la URL **/
  const urlSearchParams = new URLSearchParams(window.location.search);
  const params = Object.fromEntries(urlSearchParams.entries());
  const { GuiaPedido, OrderGuide } = params;
  /** Si tenemos un parámetro, buscamos el paquete **/
  if (GuiaPedido || OrderGuide) {
    BuscarPedidosPorNumeroDeGuia(GuiaPedido || OrderGuide);
  }
</script>
